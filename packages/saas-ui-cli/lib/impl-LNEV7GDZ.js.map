{"version":3,"sources":["../src/commands/registry/impl.ts"],"sourcesContent":["import { promises as fs } from 'node:fs'\r\nimport path from 'node:path'\r\nimport { z } from 'zod'\r\n\r\nimport type { LocalContext } from '#context'\r\nimport { getRawConfig, rawConfigSchema } from '#utils/get-config'\r\nimport { handleError } from '#utils/handle-error'\r\nimport { highlighter } from '#utils/highlighter'\r\nimport { logger } from '#utils/logger'\r\nimport { spinner } from '#utils/spinner'\r\n\r\nconst registryOptionsFlagsSchema = z.object({\r\n  cwd: z.string(),\r\n  silent: z.boolean(),\r\n  remove: z.boolean(),\r\n})\r\n\r\ntype RegistryCommandFlags = z.infer<typeof registryOptionsFlagsSchema>\r\n\r\nexport async function registry(\r\n  this: LocalContext,\r\n  flags: RegistryCommandFlags,\r\n  ...args: Array<string>\r\n): Promise<void> {\r\n  try {\r\n    const options = registryOptionsFlagsSchema.parse({\r\n      ...flags,\r\n      cwd: path.resolve(flags.cwd ?? process.cwd()),\r\n    })\r\n\r\n    const [inputName, url] = args\r\n\r\n    if (options.remove) {\r\n      if (!inputName) {\r\n        logger.error('Registry name is required.')\r\n        process.exit(1)\r\n      }\r\n      if (url) {\r\n        logger.warn('URL parameter is ignored when using --remove flag.')\r\n      }\r\n    } else {\r\n      if (!inputName || !url) {\r\n        logger.error('Both registry name and URL are required.')\r\n        process.exit(1)\r\n      }\r\n    }\r\n\r\n    const name = inputName.startsWith('@') ? inputName : `@${inputName}`\r\n\r\n    const existingConfig = await getRawConfig(options.cwd)\r\n\r\n    if (!existingConfig) {\r\n      logger.error(\r\n        `No ${highlighter.info(\r\n          'components.json',\r\n        )} found. Please run ${highlighter.info('init')} first.`,\r\n      )\r\n      process.exit(1)\r\n    }\r\n\r\n    let updatedConfig\r\n\r\n    if (options.remove) {\r\n      if (!existingConfig.registries?.[name]) {\r\n        logger.error(\r\n          `Registry ${highlighter.info(name)} not found in components.json.`,\r\n        )\r\n        process.exit(1)\r\n      }\r\n\r\n      const { [name]: removed, ...remainingRegistries } =\r\n        existingConfig.registries\r\n\r\n      updatedConfig = {\r\n        ...existingConfig,\r\n        registries: remainingRegistries,\r\n      }\r\n    } else {\r\n      updatedConfig = {\r\n        ...existingConfig,\r\n        registries: {\r\n          ...existingConfig.registries,\r\n          [name]: { url },\r\n        },\r\n      }\r\n    }\r\n\r\n    rawConfigSchema.parse(updatedConfig)\r\n\r\n    if (!options.silent) {\r\n      const action = options.remove\r\n        ? 'Removing'\r\n        : existingConfig.registries?.[name]\r\n          ? 'Updating'\r\n          : 'Adding'\r\n\r\n      const registrySpinner = spinner(\r\n        `${action} registry ${highlighter.info(name)}...`,\r\n      ).start()\r\n\r\n      try {\r\n        const targetPath = path.resolve(options.cwd, 'components.json')\r\n        await fs.writeFile(\r\n          targetPath,\r\n          JSON.stringify(updatedConfig, null, 2),\r\n          'utf8',\r\n        )\r\n        registrySpinner.succeed()\r\n      } catch (error) {\r\n        registrySpinner.fail()\r\n        throw error\r\n      }\r\n    } else {\r\n      const targetPath = path.resolve(options.cwd, 'components.json')\r\n      await fs.writeFile(\r\n        targetPath,\r\n        JSON.stringify(updatedConfig, null, 2),\r\n        'utf8',\r\n      )\r\n    }\r\n\r\n    logger.break()\r\n    const action = options.remove\r\n      ? 'removed'\r\n      : existingConfig.registries?.[name]\r\n        ? 'updated'\r\n        : 'added'\r\n    logger.log(\r\n      `${highlighter.success('Success!')} Registry ${highlighter.info(name)} has been ${action}.`,\r\n    )\r\n    logger.break()\r\n  } catch (error) {\r\n    logger.break()\r\n    handleError(error)\r\n  }\r\n}\r\n"],"mappings":"4GAAA,OAAS,YAAYA,MAAU,KAC/B,OAAOC,MAAU,OACjB,OAAS,KAAAC,MAAS,MASlB,IAAMC,EAA6BC,EAAE,OAAO,CAC1C,IAAKA,EAAE,OAAO,EACd,OAAQA,EAAE,QAAQ,EAClB,OAAQA,EAAE,QAAQ,CACpB,CAAC,EAID,eAAsBC,EAEpBC,KACGC,EACY,CACf,GAAI,CACF,IAAMC,EAAUL,EAA2B,MAAM,CAC/C,GAAGG,EACH,IAAKG,EAAK,QAAQH,EAAM,KAAO,QAAQ,IAAI,CAAC,CAC9C,CAAC,EAEK,CAACI,EAAWC,CAAG,EAAIJ,EAErBC,EAAQ,QACLE,IACHE,EAAO,MAAM,4BAA4B,EACzC,QAAQ,KAAK,CAAC,GAEZD,GACFC,EAAO,KAAK,oDAAoD,IAG9D,CAACF,GAAa,CAACC,KACjBC,EAAO,MAAM,0CAA0C,EACvD,QAAQ,KAAK,CAAC,GAIlB,IAAMC,EAAOH,EAAU,WAAW,GAAG,EAAIA,EAAY,IAAIA,CAAS,GAE5DI,EAAiB,MAAMC,EAAaP,EAAQ,GAAG,EAEhDM,IACHF,EAAO,MACL,MAAMI,EAAY,KAChB,iBACF,CAAC,sBAAsBA,EAAY,KAAK,MAAM,CAAC,SACjD,EACA,QAAQ,KAAK,CAAC,GAGhB,IAAIC,EAEJ,GAAIT,EAAQ,OAAQ,CACbM,EAAe,aAAaD,CAAI,IACnCD,EAAO,MACL,YAAYI,EAAY,KAAKH,CAAI,CAAC,gCACpC,EACA,QAAQ,KAAK,CAAC,GAGhB,GAAM,CAAE,CAACA,CAAI,EAAGK,EAAS,GAAGC,CAAoB,EAC9CL,EAAe,WAEjBG,EAAgB,CACd,GAAGH,EACH,WAAYK,CACd,CACF,MACEF,EAAgB,CACd,GAAGH,EACH,WAAY,CACV,GAAGA,EAAe,WAClB,CAACD,CAAI,EAAG,CAAE,IAAAF,CAAI,CAChB,CACF,EAKF,GAFAS,EAAgB,MAAMH,CAAa,EAE9BT,EAAQ,OAuBN,CACL,IAAMa,EAAaZ,EAAK,QAAQD,EAAQ,IAAK,iBAAiB,EAC9D,MAAMc,EAAG,UACPD,EACA,KAAK,UAAUJ,EAAe,KAAM,CAAC,EACrC,MACF,CACF,KA9BqB,CACnB,IAAMM,EAASf,EAAQ,OACnB,WACAM,EAAe,aAAaD,CAAI,EAC9B,WACA,SAEAW,EAAkBC,EACtB,GAAGF,CAAM,aAAaP,EAAY,KAAKH,CAAI,CAAC,KAC9C,EAAE,MAAM,EAER,GAAI,CACF,IAAMQ,EAAaZ,EAAK,QAAQD,EAAQ,IAAK,iBAAiB,EAC9D,MAAMc,EAAG,UACPD,EACA,KAAK,UAAUJ,EAAe,KAAM,CAAC,EACrC,MACF,EACAO,EAAgB,QAAQ,CAC1B,OAASE,EAAO,CACd,MAAAF,EAAgB,KAAK,EACfE,CACR,CACF,CASAd,EAAO,MAAM,EACb,IAAMW,EAASf,EAAQ,OACnB,UACAM,EAAe,aAAaD,CAAI,EAC9B,UACA,QACND,EAAO,IACL,GAAGI,EAAY,QAAQ,UAAU,CAAC,aAAaA,EAAY,KAAKH,CAAI,CAAC,aAAaU,CAAM,GAC1F,EACAX,EAAO,MAAM,CACf,OAASc,EAAO,CACdd,EAAO,MAAM,EACbe,EAAYD,CAAK,CACnB,CACF","names":["fs","path","z","registryOptionsFlagsSchema","z","registry","flags","args","options","path","inputName","url","logger","name","existingConfig","getRawConfig","highlighter","updatedConfig","removed","remainingRegistries","rawConfigSchema","targetPath","fs","action","registrySpinner","spinner","error","handleError"]}