{"version":3,"sources":["../src/commands/add/impl.ts","../src/preflights/preflight-add.ts"],"sourcesContent":["import kleur from 'kleur'\nimport path from 'path'\nimport prompts from 'prompts'\nimport { z } from 'zod'\n\nimport * as ERRORS from '#utils/errors'\nimport { runInit } from '#commands/init/impl'\nimport { preFlightAdd } from '#preflights/preflight-add'\nimport { addComponents } from '#utils/add-components'\nimport { getConfig } from '#utils/get-config.js'\nimport { handleError } from '#utils/handle-error'\nimport { highlighter } from '#utils/highlighter'\nimport { logger } from '#utils/logger'\nimport { getRegistryIndex } from '#utils/registry'\n\nimport type { LocalContext } from '../../context'\n\nexport const addOptionsFlagsSchema = z.object({\n  // components: z.array(z.string()).optional(),\n  yes: z.boolean(),\n  overwrite: z.boolean(),\n  cwd: z.string().optional(),\n  all: z.boolean(),\n  path: z.string().optional(),\n  silent: z.boolean(),\n  srcDir: z.boolean().optional(),\n})\n\nconst addOptionsSchema = addOptionsFlagsSchema.extend({\n  components: z.array(z.string()).optional(),\n})\n\ntype AddCommandFlags = z.infer<typeof addOptionsFlagsSchema>\ntype AddCommandOptions = z.infer<typeof addOptionsSchema>\n\nexport type AddOptions = AddCommandOptions & {\n  cwd: string\n}\n\nexport async function add(\n  this: LocalContext,\n  flags: AddCommandFlags,\n  ...components: Array<string>\n): Promise<void> {\n  try {\n    // allow namespaced components to be written without the @ prefix\n    const normalizedComponents = components.map((component) => {\n      if (component.includes('/') && !component.startsWith('@')) {\n        return `@${component}`\n      }\n      return component\n    })\n\n    const parsedFlags = addOptionsSchema.parse({\n      ...flags,\n      components: normalizedComponents ?? [],\n    })\n\n    const options = {\n      ...parsedFlags,\n      cwd: path.resolve(parsedFlags.cwd ?? process.cwd()),\n    }\n\n    const originalCwd = options.cwd\n    const result = await preFlightAdd(options)\n\n    if (!options.components?.length) {\n      options.components = await promptForRegistryComponents(options, options)\n    }\n\n    if (options.cwd !== originalCwd) {\n      logger.info(\n        `Detected monorepo. Adding components to ${highlighter.info('packages/ui/')}`,\n      )\n      logger.break()\n    }\n\n    let config = result.config\n\n    if (result.errors[ERRORS.MISSING_CONFIG]) {\n      const { proceed } = await prompts({\n        type: 'confirm',\n        name: 'proceed',\n        message: `You need to create a ${highlighter.info(\n          'components.json',\n        )} file to add components. Proceed?`,\n        initial: true,\n      })\n\n      if (!proceed) {\n        logger.break()\n        process.exit(1)\n      }\n\n      config = await runInit({\n        cwd: options.cwd,\n        yes: true,\n        force: true,\n        defaults: false,\n        skipPreflight: false,\n        silent: true,\n        isNewProject: false,\n        monorepo: false\n      })\n    }\n\n    if (!config) {\n      throw new Error(\n        `Failed to read config at ${highlighter.info(options.cwd)}.`,\n      )\n    }\n\n    await addComponents(options.components, config, options)\n  } catch (error) {\n    logger.break()\n    handleError(error)\n  }\n}\n\nasync function promptForRegistryComponents(\n  options: z.infer<typeof addOptionsSchema>,\n  config: z.infer<typeof addOptionsFlagsSchema> & { cwd: string },\n) {\n  const fullConfig = await getConfig(config.cwd)\n\n  if (!fullConfig) {\n    logger.break()\n    handleError(new Error('Failed to read config.'))\n    return []\n  }\n\n  const registryIndex = await getRegistryIndex()\n  if (!registryIndex) {\n    logger.break()\n    handleError(new Error('Failed to fetch registry index.'))\n    return []\n  }\n\n  if (options.all) {\n    return registryIndex.map((entry) => entry.name)\n  }\n\n  if (options.components?.length) {\n    return options.components\n  }\n\n  const { components } = await prompts({\n    type: 'autocompleteMultiselect',\n    name: 'components',\n    message: 'Which components would you like to add?',\n    hint: 'Space to select. A to toggle all. Enter to submit.',\n    instructions: false,\n    choices: registryIndex\n      .filter((entry) => entry.type === 'registry:block')\n      .map((entry) => ({\n        title: `${entry.category}/${entry.subcategory}/${entry.name} ${entry.private ? kleur.blue(kleur.bold('(PRO)')) : ''}`,\n        value: entry.name,\n        selected: options.all ? true : options.components?.includes(entry.name),\n      })),\n  })\n\n  if (!components?.length) {\n    logger.warn('No components selected. Exiting.')\n    logger.info('')\n    process.exit(1)\n  }\n\n  const result = z.array(z.string()).safeParse(components)\n  if (!result.success) {\n    logger.error('')\n    handleError(new Error('Something went wrong. Please try again.'))\n    return []\n  }\n  return result.data\n}\n","import fs from 'fs-extra'\nimport path from 'path'\n\nimport * as ERRORS from '#utils/errors'\nimport { type AddOptions } from '#commands/add/impl'\nimport { detectMonorepo } from '#utils/detect-monorepo'\nimport { getConfig } from '#utils/get-config'\nimport { highlighter } from '#utils/highlighter'\nimport { logger } from '#utils/logger'\n\nexport async function preFlightAdd(options: AddOptions) {\n  const errors: Record<string, boolean> = {}\n\n  // Ensure target directory exists.\n  if (!fs.existsSync(options.cwd)) {\n    errors[ERRORS.MISSING_DIR_OR_EMPTY_PROJECT] = true\n    return {\n      errors,\n      config: null,\n    }\n  }\n\n  const monorepoInfo = await detectMonorepo(options.cwd)\n  logger.debug(`Monorepo detected: ${monorepoInfo.isMonorepo}`)\n  if (monorepoInfo.isMonorepo) {\n    logger.debug(`Monorepo type: ${monorepoInfo.type}`)\n    logger.debug(`Monorepo root: ${monorepoInfo.root}`)\n  }\n\n  if (!fs.existsSync(path.resolve(options.cwd, 'package.json'))) {\n    errors[ERRORS.MISSING_DIR_OR_EMPTY_PROJECT] = true\n    logger.debug(`No package.json found in ${options.cwd}`)\n    return {\n      errors,\n      config: null,\n    }\n  }\n\n  // Check for components.json\n  let componentsJsonPath = path.resolve(options.cwd, 'components.json')\n  let actualCwd = options.cwd\n\n  logger.debug(`Looking for components.json at: ${componentsJsonPath}`)\n\n  if (!fs.existsSync(componentsJsonPath) && monorepoInfo.isMonorepo) {\n    logger.debug(`Not found in cwd, checking monorepo locations...`)\n\n    const uiPackagePath = path.join(\n      options.cwd,\n      'packages',\n      'ui',\n      'components.json',\n    )\n    logger.debug(`Checking: ${uiPackagePath}`)\n\n    if (fs.existsSync(uiPackagePath)) {\n      componentsJsonPath = uiPackagePath\n      actualCwd = path.join(options.cwd, 'packages', 'ui')\n      logger.debug(`Found components.json in UI package, using: ${actualCwd}`)\n    } else if (monorepoInfo.root) {\n      const rootUiPath = path.join(\n        monorepoInfo.root,\n        'packages',\n        'ui',\n        'components.json',\n      )\n      logger.debug(`Checking from root: ${rootUiPath}`)\n\n      if (fs.existsSync(rootUiPath)) {\n        componentsJsonPath = rootUiPath\n        actualCwd = path.join(monorepoInfo.root, 'packages', 'ui')\n        logger.debug(\n          `Found components.json in UI package from root, using: ${actualCwd}`,\n        )\n      }\n    }\n  }\n\n  if (!fs.existsSync(componentsJsonPath)) {\n    errors[ERRORS.MISSING_CONFIG] = true\n    logger.debug(`components.json not found at any location`)\n    return {\n      errors,\n      config: null,\n    }\n  }\n\n  logger.debug(`components.json found at: ${componentsJsonPath}`)\n  logger.debug(`Using cwd: ${actualCwd}`)\n\n  options.cwd = actualCwd\n\n  try {\n    const config = await getConfig(options.cwd!)\n\n    return {\n      errors,\n      config: config!,\n    }\n  } catch (error) {\n    logger.debug(error)\n    console.log(error)\n    logger.break()\n    logger.error(\n      `An invalid ${highlighter.info(\n        'components.json',\n      )} file was found at ${highlighter.info(\n        options.cwd,\n      )}.\\nBefore you can add components, you must create a valid ${highlighter.info(\n        'components.json',\n      )} file by running the ${highlighter.info('init')} command.`,\n    )\n    logger.error(\n      `Learn more at ${highlighter.info(\n        'https://saas-ui.dev/docs/components-json',\n      )}.`,\n    )\n    logger.break()\n    process.exit(1)\n  }\n}\n"],"mappings":"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","names":["kleur","path","prompts","z","fs","path","preFlightAdd","options","errors","fs","monorepoInfo","detectMonorepo","logger","path","componentsJsonPath","actualCwd","uiPackagePath","rootUiPath","config","getConfig","error","highlighter","addOptionsFlagsSchema","z","addOptionsSchema","add","flags","components","normalizedComponents","component","parsedFlags","options","path","originalCwd","result","preFlightAdd","promptForRegistryComponents","logger","highlighter","config","proceed","prompts","runInit","addComponents","error","handleError","getConfig","registryIndex","getRegistryIndex","entry","kleur"]}