{"version":3,"sources":["../src/commands/login/impl.ts","../src/lib/supabase.ts"],"sourcesContent":["import { serve } from '@hono/node-server'\nimport { Hono } from 'hono'\nimport { cors } from 'hono/cors'\nimport open from 'open'\nimport ora from 'ora'\n\nimport { AUTH_ORIGIN } from '#constants'\nimport type { LocalContext } from '#context'\nimport { createSupabaseClient } from '#lib/supabase'\nimport { writeConfig } from '#utils/auth'\n\ninterface LoginResponse {\n  token?: string\n}\n\nexport async function login(this: LocalContext) {\n  const responsePromise = new Promise<LoginResponse>((resolve, reject) => {\n    const app = new Hono()\n\n    let token: string | undefined\n\n    app.use(\n      cors({\n        origin: AUTH_ORIGIN,\n        allowMethods: ['GET'],\n        allowHeaders: ['Authorization'],\n      }),\n    )\n\n    app.use('/callback', async (c, next) => {\n      await next()\n      resolve({ token })\n    })\n\n    app.get('/callback', async (c) => {\n      const authHeader = c.req.header('Authorization')\n\n      if (!authHeader) {\n        return c.json(\n          { success: false, error: 'No authorization header provided' },\n          400,\n        )\n      }\n\n      token = authHeader.split(' ')[1]\n\n      if (!token) {\n        return c.json({ success: false, error: 'No token provided' }, 400)\n      }\n\n      return c.json({ success: true }, 200)\n    })\n\n    app.get('/success', async (c) =>\n      c.text('Login successful, you can close this tab.'),\n    )\n\n    app.get('/cancel', async (c) => {\n      reject(new Error('Login cancelled'))\n      return c.text('Login cancelled, you can close this tab.')\n    })\n\n    app.get('/error', async (c) => {\n      reject(new Error('Login error'))\n      return c.text('Login failed, you can close this tab.')\n    })\n\n    const server = serve({\n      fetch: app.fetch,\n      hostname: 'localhost',\n    })\n\n    server.listen()\n\n    const address = server.address()\n\n    let port: number | undefined\n    if (!address) {\n      reject(new Error('Failed to start server'))\n      return\n    }\n\n    if (typeof address === 'string') {\n      port = parseInt(address.split(':')[2] ?? '')\n    } else {\n      port = address.port\n    }\n\n    open(`${AUTH_ORIGIN}/login?callbackPort=${port}`)\n\n    console.log(\n      `If nothing happens, open the following URL in your browser: ${AUTH_ORIGIN}/login?callbackPort=${port}`,\n    )\n  })\n\n  const spinner = ora({\n    text: 'Authenticating...',\n    color: 'green',\n  })\n\n  try {\n    spinner.start()\n\n    const response = await responsePromise\n\n    spinner.stop()\n\n    if (!response.token) {\n      console.error('Failed to authenticate, please try again.')\n      return\n    }\n\n    const supabase = createSupabaseClient(response.token)\n\n    const { data, error } = await supabase.auth.getUser()\n\n    if (error) {\n      console.error('Failed to authenticate, please try again.')\n      return\n    }\n\n    console.log(`Hi ${data.user.email}, you are now logged in.`)\n\n    writeConfig({ token: response.token })\n  } catch (error) {\n    spinner.stop()\n    console.error(error)\n  }\n}\n","import { createClient } from '@supabase/supabase-js'\n\nexport function createSupabaseClient(token: string) {\n  return createClient(\n    /* @ts-ignore */\n    process.env.SUPABASE_URL!,\n    /* @ts-ignore */\n    process.env.SUPABASE_ANON_KEY!,\n    {\n      global: {\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n      },\n    },\n  )\n}\n"],"mappings":"0CAAA,OAAS,SAAAA,MAAa,oBACtB,OAAS,QAAAC,MAAY,OACrB,OAAS,QAAAC,MAAY,YACrB,OAAOC,MAAU,OACjB,OAAOC,MAAS,MCJhB,OAAS,gBAAAC,MAAoB,wBAEtB,SAASC,EAAqBC,EAAe,CAClD,OAAOF,EAEL,2CAEA,mNACA,CACE,OAAQ,CACN,QAAS,CACP,cAAe,UAAUE,CAAK,EAChC,CACF,CACF,CACF,CACF,CDDA,eAAsBC,GAA0B,CAC9C,IAAMC,EAAkB,IAAI,QAAuB,CAACC,EAASC,IAAW,CACtE,IAAMC,EAAM,IAAIC,EAEZC,EAEJF,EAAI,IACFG,EAAK,CACH,OAAQC,EACR,aAAc,CAAC,KAAK,EACpB,aAAc,CAAC,eAAe,CAChC,CAAC,CACH,EAEAJ,EAAI,IAAI,YAAa,MAAOK,EAAGC,IAAS,CACtC,MAAMA,EAAK,EACXR,EAAQ,CAAE,MAAAI,CAAM,CAAC,CACnB,CAAC,EAEDF,EAAI,IAAI,YAAa,MAAOK,GAAM,CAChC,IAAME,EAAaF,EAAE,IAAI,OAAO,eAAe,EAE/C,OAAKE,GAOLL,EAAQK,EAAW,MAAM,GAAG,EAAE,CAAC,EAE1BL,EAIEG,EAAE,KAAK,CAAE,QAAS,EAAK,EAAG,GAAG,EAH3BA,EAAE,KAAK,CAAE,QAAS,GAAO,MAAO,mBAAoB,EAAG,GAAG,GAT1DA,EAAE,KACP,CAAE,QAAS,GAAO,MAAO,kCAAmC,EAC5D,GACF,CAUJ,CAAC,EAEDL,EAAI,IAAI,WAAY,MAAOK,GACzBA,EAAE,KAAK,2CAA2C,CACpD,EAEAL,EAAI,IAAI,UAAW,MAAOK,IACxBN,EAAO,IAAI,MAAM,iBAAiB,CAAC,EAC5BM,EAAE,KAAK,0CAA0C,EACzD,EAEDL,EAAI,IAAI,SAAU,MAAOK,IACvBN,EAAO,IAAI,MAAM,aAAa,CAAC,EACxBM,EAAE,KAAK,uCAAuC,EACtD,EAED,IAAMG,EAASC,EAAM,CACnB,MAAOT,EAAI,MACX,SAAU,WACZ,CAAC,EAEDQ,EAAO,OAAO,EAEd,IAAME,EAAUF,EAAO,QAAQ,EAE3BG,EACJ,GAAI,CAACD,EAAS,CACZX,EAAO,IAAI,MAAM,wBAAwB,CAAC,EAC1C,MACF,CAEI,OAAOW,GAAY,SACrBC,EAAO,SAASD,EAAQ,MAAM,GAAG,EAAE,CAAC,GAAK,EAAE,EAE3CC,EAAOD,EAAQ,KAGjBE,EAAK,GAAGR,CAAW,uBAAuBO,CAAI,EAAE,EAEhD,QAAQ,IACN,+DAA+DP,CAAW,uBAAuBO,CAAI,EACvG,CACF,CAAC,EAEKE,EAAUC,EAAI,CAClB,KAAM,oBACN,MAAO,OACT,CAAC,EAED,GAAI,CACFD,EAAQ,MAAM,EAEd,IAAME,EAAW,MAAMlB,EAIvB,GAFAgB,EAAQ,KAAK,EAET,CAACE,EAAS,MAAO,CACnB,QAAQ,MAAM,2CAA2C,EACzD,MACF,CAEA,IAAMC,EAAWC,EAAqBF,EAAS,KAAK,EAE9C,CAAE,KAAAG,EAAM,MAAAC,CAAM,EAAI,MAAMH,EAAS,KAAK,QAAQ,EAEpD,GAAIG,EAAO,CACT,QAAQ,MAAM,2CAA2C,EACzD,MACF,CAEA,QAAQ,IAAI,MAAMD,EAAK,KAAK,KAAK,0BAA0B,EAE3DE,EAAY,CAAE,MAAOL,EAAS,KAAM,CAAC,CACvC,OAASI,EAAO,CACdN,EAAQ,KAAK,EACb,QAAQ,MAAMM,CAAK,CACrB,CACF","names":["serve","Hono","cors","open","ora","createClient","createSupabaseClient","token","login","responsePromise","resolve","reject","app","Hono","token","cors","AUTH_ORIGIN","c","next","authHeader","server","serve","address","port","open","spinner","ora","response","supabase","createSupabaseClient","data","error","writeConfig"]}