{"version":3,"sources":["../src/commands/diff/impl.ts"],"sourcesContent":["import { type Change, diffLines } from 'diff'\nimport { existsSync, promises as fs } from 'node:fs'\nimport path from 'node:path'\nimport { z } from 'zod'\n\nimport type { LocalContext } from '#context'\nimport { detectMonorepo } from '#utils/detect-monorepo'\nimport { type Config, getConfig } from '#utils/get-config'\nimport { handleError } from '#utils/handle-error'\nimport { highlighter } from '#utils/highlighter'\nimport { logger } from '#utils/logger'\nimport {\n  getRegistryIndex,\n  getRegistryItemFileTargetPath,\n  registryResolveItemsTree,\n} from '#utils/registry'\nimport {\n  type RegistryItem,\n  registryItemFileSchema,\n} from '#utils/registry/schema'\nimport { transform } from '#utils/transformers'\nimport { transformImport } from '#utils/transformers/transform-import'\nimport { transformRsc } from '#utils/transformers/transform-rsc'\n\nconst diffOptionsSchema = z.object({\n  component: z.string().optional(),\n  yes: z.boolean(),\n  cwd: z.string().optional(),\n})\n\ntype DiffOptions = z.infer<typeof diffOptionsSchema>\n\ntype RegistryIndexItem = Omit<RegistryItem, 'files'> & {\n  files?: Array<string | z.infer<typeof registryItemFileSchema>>\n}\n\nexport async function diff(\n  this: LocalContext,\n  flags: Omit<DiffOptions, 'component'>,\n  ...components: Array<string>\n): Promise<void> {\n  try {\n    const options = diffOptionsSchema.parse({\n      ...flags,\n      component: components[0],\n      cwd: flags.cwd ?? process.cwd(),\n    })\n\n    let cwd = path.resolve(options.cwd!)\n\n    if (!existsSync(cwd)) {\n      logger.error(`The path ${cwd} does not exist. Please try again.`)\n      process.exit(1)\n    }\n\n    const monorepoInfo = await detectMonorepo(cwd)\n    logger.debug(`Monorepo detected: ${monorepoInfo.isMonorepo}`)\n\n    let componentsJsonPath = path.resolve(cwd, 'components.json')\n\n    if (!existsSync(componentsJsonPath) && monorepoInfo.isMonorepo) {\n      logger.debug(`Looking for components.json in monorepo packages...`)\n\n      const uiPackagePath = path.join(cwd, 'packages', 'ui', 'components.json')\n\n      if (existsSync(uiPackagePath)) {\n        cwd = path.join(cwd, 'packages', 'ui')\n        componentsJsonPath = uiPackagePath\n        logger.info(\n          `Detected monorepo. Checking components in ${highlighter.info('packages/ui/')}`,\n        )\n        logger.break()\n      } else if (monorepoInfo.root) {\n        const rootUiPath = path.join(\n          monorepoInfo.root,\n          'packages',\n          'ui',\n          'components.json',\n        )\n\n        if (existsSync(rootUiPath)) {\n          cwd = path.join(monorepoInfo.root, 'packages', 'ui')\n          componentsJsonPath = rootUiPath\n          logger.info(\n            `Detected monorepo. Checking components in ${highlighter.info('packages/ui/')}`,\n          )\n          logger.break()\n        }\n      }\n    }\n\n    const config = await getConfig(cwd)\n    if (!config) {\n      logger.warn(\n        `Configuration is missing. Please run ${highlighter.info(\n          'init',\n        )} to create a components.json file.`,\n      )\n      process.exit(1)\n    }\n\n    const registryIndex = await getRegistryIndex()\n    if (!registryIndex) {\n      handleError(new Error('Failed to fetch registry index.'))\n      process.exit(1)\n    }\n\n    if (!options.component) {\n      await checkAllComponents(registryIndex, config)\n    } else {\n      await checkSingleComponent(options.component, registryIndex, config)\n    }\n  } catch (error) {\n    handleError(error)\n  }\n}\n\nasync function checkAllComponents(\n  registryIndex: Array<RegistryIndexItem>,\n  config: Config,\n) {\n  const projectComponents = []\n\n  // console.log('registryIndex', registryIndex)\n\n  for (const item of registryIndex) {\n    if (!item.files?.length) continue\n\n    const exists = await checkComponentExists(item, config)\n    if (exists) {\n      projectComponents.push(item)\n    }\n  }\n\n  if (projectComponents.length === 0) {\n    logger.info('No components found in your project.')\n    process.exit(0)\n  }\n\n  const componentsWithUpdates = []\n  for (const component of projectComponents) {\n    const changes = await diffComponent(component, config)\n    if (changes.length) {\n      componentsWithUpdates.push({\n        name: component.name,\n        changes,\n      })\n    }\n  }\n\n  if (!componentsWithUpdates.length) {\n    logger.info('All components are up to date.')\n    process.exit(0)\n  }\n\n  logger.info('The following components have updates available:')\n  logger.break()\n  for (const component of componentsWithUpdates) {\n    logger.info(`- ${highlighter.info(component.name)}`)\n    for (const change of component.changes) {\n      logger.log(`  - ${change.filePath}`)\n    }\n  }\n  logger.break()\n  logger.info(\n    `Run ${highlighter.success(`sui diff <component>`)} to see the changes.`,\n  )\n  logger.info(\n    `Run ${highlighter.success(`sui add ${componentsWithUpdates.map((component) => component.name).join(' ')} --overwrite`)} to update the component(s).`,\n  )\n}\n\nasync function checkSingleComponent(\n  componentName: string,\n  registryIndex: Array<RegistryIndexItem>,\n  config: Config,\n) {\n  const component = registryIndex.find((item) => item.name === componentName)\n\n  if (!component) {\n    logger.error(\n      `The component ${highlighter.info(\n        componentName,\n      )} does not exist in the registry.`,\n    )\n    process.exit(1)\n  }\n\n  const exists = await checkComponentExists(component, config)\n  if (!exists) {\n    logger.error(\n      `The component ${highlighter.info(\n        componentName,\n      )} is not installed in your project.`,\n    )\n    process.exit(1)\n  }\n\n  const changes = await diffComponent(component, config)\n\n  if (!changes.length) {\n    logger.info(`No updates found for ${highlighter.info(componentName)}.`)\n    process.exit(0)\n  }\n\n  logger.info(`Updates available for ${highlighter.info(componentName)}:`)\n  logger.break()\n  for (const change of changes) {\n    logger.info(`File: ${highlighter.info(change.filePath)}`)\n    logger.break()\n    await printDiff(change.patch)\n    logger.break()\n  }\n}\n\nasync function checkComponentExists(\n  component: RegistryIndexItem,\n  config: Config,\n): Promise<boolean> {\n  if (!component.files?.length) return false\n\n  for (const file of component.files) {\n    if (typeof file === 'string') continue\n\n    const targetDir = getRegistryItemFileTargetPath(file, config)\n    const fileName = path.basename(file.path)\n    let filePath = path.join(targetDir, fileName)\n\n    if (!config.tsx) {\n      filePath = filePath.replace(/\\.tsx?$/, (match) =>\n        match === '.tsx' ? '.jsx' : '.js',\n      )\n    }\n\n    if (existsSync(filePath)) {\n      return true\n    }\n  }\n\n  return false\n}\n\nasync function diffComponent(\n  component: RegistryIndexItem,\n  config: Config,\n): Promise<Array<{ filePath: string; patch: Change[] }>> {\n  const changes = []\n\n  const tree = await registryResolveItemsTree([component.name], config)\n  if (!tree || !tree.files) {\n    return []\n  }\n\n  for (const file of tree.files) {\n    if (!file.content) continue\n\n    const targetDir = getRegistryItemFileTargetPath(file, config)\n    const fileName = path.basename(file.path)\n    let filePath = path.join(targetDir, fileName)\n\n    if (file.target) {\n      filePath = file.target.startsWith('~/')\n        ? path.join(config.resolvedPaths.cwd, file.target.replace('~/', ''))\n        : path.join(config.resolvedPaths.cwd, file.target)\n    }\n\n    if (!config.tsx) {\n      filePath = filePath.replace(/\\.tsx?$/, (match) =>\n        match === '.tsx' ? '.jsx' : '.js',\n      )\n    }\n\n    if (!existsSync(filePath)) {\n      continue\n    }\n\n    const currentContent = await fs.readFile(filePath, 'utf8')\n\n    const registryContent = await transform(\n      {\n        filename: file.path,\n        raw: file.content,\n        config,\n        transformJsx: !config.tsx,\n      },\n      [transformImport, transformRsc],\n    )\n\n    const patch = diffLines(currentContent, registryContent)\n    if (patch.length > 1) {\n      changes.push({\n        filePath: path.relative(config.resolvedPaths.cwd, filePath),\n        patch,\n      })\n    }\n  }\n\n  return changes\n}\n\nasync function printDiff(diff: Change[]) {\n  diff.forEach((part) => {\n    if (part) {\n      if (part.added) {\n        return process.stdout.write(highlighter.success(`+ ${part.value}`))\n      }\n      if (part.removed) {\n        return process.stdout.write(highlighter.error(`- ${part.value}`))\n      }\n      return process.stdout.write(`  ${part.value}`)\n    }\n  })\n}\n"],"mappings":"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","names":["diffLines","existsSync","fs","path","z","diffOptionsSchema","z","diff","flags","components","options","cwd","path","existsSync","logger","monorepoInfo","detectMonorepo","componentsJsonPath","uiPackagePath","highlighter","rootUiPath","config","getConfig","registryIndex","getRegistryIndex","handleError","checkSingleComponent","checkAllComponents","error","projectComponents","item","checkComponentExists","componentsWithUpdates","component","changes","diffComponent","change","componentName","printDiff","file","targetDir","getRegistryItemFileTargetPath","fileName","filePath","match","tree","registryResolveItemsTree","currentContent","fs","registryContent","transform","transformImport","transformRsc","patch","diffLines","part"]}