import{e as C}from"./chunk-RWM7Q2YQ.js";import{HttpsProxyAgent as V}from"https-proxy-agent";import j from"node-fetch";import{promises as G}from"fs";import{z as m}from"zod";console.log("process.env.REGISTRY_URL","http://localhost:4000");var I="http://localhost:4000",W="http://localhost:4000/r/schema.json";function l(t){return t.replace(/\${(\w+)}/g,(r,e)=>process.env[e]||"")}import{z as S}from"zod";var g={NETWORK_ERROR:"NETWORK_ERROR",NOT_FOUND:"NOT_FOUND",UNAUTHORIZED:"UNAUTHORIZED",FORBIDDEN:"FORBIDDEN",FETCH_ERROR:"FETCH_ERROR",NOT_CONFIGURED:"NOT_CONFIGURED",INVALID_CONFIG:"INVALID_CONFIG",MISSING_ENV_VARS:"MISSING_ENV_VARS",LOCAL_FILE_ERROR:"LOCAL_FILE_ERROR",PARSE_ERROR:"PARSE_ERROR",VALIDATION_ERROR:"VALIDATION_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR"},u=class extends Error{code;statusCode;context;suggestion;timestamp;cause;constructor(r,e={}){super(r),this.name="RegistryError",this.code=e.code||g.UNKNOWN_ERROR,this.statusCode=e.statusCode,this.cause=e.cause,this.context=e.context,this.suggestion=e.suggestion,this.timestamp=new Date,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},f=class extends u{constructor(e,s){let n=`The item at ${e} was not found. It may not exist at the registry.`;super(n,{code:g.NOT_FOUND,statusCode:404,cause:s,context:{url:e},suggestion:"Check if the item name is correct and the registry URL is accessible."});this.url=e;this.name="RegistryNotFoundError"}},h=class extends u{constructor(e,s){let n=`You are not authorized to access the item at ${e}. If this is a remote registry, you may need to authenticate.`;super(n,{code:g.UNAUTHORIZED,statusCode:401,cause:s,context:{url:e},suggestion:"Check your authentication credentials and environment variables."});this.url=e;this.name="RegistryUnauthorizedError"}},y=class extends u{constructor(e,s){let n=`You are not authorized to access the item at ${e}. If this is a remote registry, you may need to authenticate.`;super(n,{code:g.FORBIDDEN,statusCode:403,cause:s,context:{url:e},suggestion:"Check your authentication credentials and environment variables."});this.url=e;this.name="RegistryForbiddenError"}},E=class extends u{constructor(e,s,n,o){let c=s?`Failed to fetch from registry (${s}): ${e}`:`Failed to fetch from registry: ${e}`,i=typeof o=="string"&&o?`${c} - ${o}`:c,a="Check your network connection and try again.";s===404?a="The requested resource was not found. Check the URL or item name.":s===500?a="The registry server encountered an error. Try again later.":s&&s>=400&&s<500&&(a="There was a client error. Check your request parameters.");super(i,{code:g.FETCH_ERROR,statusCode:s,cause:o,context:{url:e,responseBody:n},suggestion:a});this.url=e;this.responseBody=n;this.name="RegistryFetchError"}},R=class extends u{constructor(e){let s=e?`Unknown registry "${e}". Make sure it is defined in components.json as follows:
{
  "registries": {
    "${e}": "[URL_TO_REGISTRY]"
  }
}`:'Unknown registry. Make sure it is defined in components.json under "registries".';super(s,{code:g.NOT_CONFIGURED,context:{registryName:e},suggestion:"Add the registry configuration to your components.json file."});this.registryName=e;this.name="RegistryNotConfiguredError"}},x=class extends u{constructor(e,s){super(`Failed to read local registry file: ${e}`,{code:g.LOCAL_FILE_ERROR,cause:s,context:{filePath:e},suggestion:"Check if the file exists and you have read permissions."});this.filePath=e;this.name="RegistryLocalFileError"}},p=class extends u{constructor(e,s){let n=`Failed to parse registry item: ${e}`;s instanceof S.ZodError&&(n=`Failed to parse registry item: ${e}
${s.message}`);super(n,{code:g.PARSE_ERROR,cause:s,context:{item:e},suggestion:"The registry item may be corrupted or have an invalid format."});this.item=e;this.parseError=s,this.name="RegistryParseError"}parseError};var k=/^(@[a-zA-Z0-9](?:[a-zA-Z0-9-_]*[a-zA-Z0-9])?)\/(.+)$/;function N(t){if(!t.startsWith("@"))return{registry:null,item:t};let r=t.match(k);return r?{registry:r[1],item:r[2]}:{registry:null,item:t}}function A(t){try{return new URL(t),!0}catch{return!1}}function q(t){return t.startsWith(".")||t.startsWith("/")}var T="{name}",O="{style}",F=/\${(\w+)}/g;function re(t,r){let{registry:e,item:s}=N(t);if(!e||!s)return null;let o=(r?.registries||{})[e];if(!o)throw new R(e);let c=v(s,o,r);if(!c)throw new R(e);return{url:c,headers:$(o)}}function v(t,r,e){if(!r)return null;if(typeof r=="string"){let n=r.replace(T,t);return e?.style&&n.includes(O)&&(n=n.replace(O,e.style)),l(n)}let s=r.url.replace(T,t);return e?.style&&s.includes(O)&&(s=s.replace(O,e.style)),s=l(s),r.params?D(s,r.params):s}function $(t){if(typeof t=="string"||!t.headers)return{};let r={};for(let[e,s]of Object.entries(t.headers)){let n=l(s);H(s,n)&&(r[e]=n)}return r}function D(t,r){let e=new URLSearchParams;for(let[o,c]of Object.entries(r)){let i=l(c);i&&e.append(o,i)}let s=e.toString();if(!s)return t;let n=t.includes("?")?"&":"?";return`${t}${n}${s}`}function H(t,r){let e=r.trim();if(!e)return!1;if(t.includes("${")&&t.match(F)){let n=t.replace(F,"").trim();return e!==n}return!0}function b(t){if(A(t)){let r=new URL(t);return r.pathname.match(/\/chat\/b\//)&&!r.pathname.endsWith("/json")&&(r.pathname=`${r.pathname}/json`),r.toString()}return`${I}/${t}`}var w={headers:{}};function ne(t){w.headers={...w.headers,...t}}function L(t){return w.headers[t]||{}}function oe(){w.headers={}}var P=process.env.https_proxy?new V(process.env.https_proxy):void 0,_=new Map;function fe(){_.clear()}async function he(t,r={}){return r={useCache:!0,...r},await Promise.all(t.map(async s=>{let n=b(s);if(r.useCache&&_.has(n))return _.get(n);let o=(async()=>{let c=L(n),i=await j(n,{agent:P,headers:{...c}});if(!i.ok){let a;if(i.headers.get("content-type")?.includes("application/json")){let U=await i.json(),d=m.object({detail:m.string().optional(),title:m.string().optional(),message:m.string().optional(),error:m.string().optional()}).safeParse(U);d.success&&(a=d.data.detail||d.data.message,d.data.error&&(a=`[${d.data.error}] ${a}`))}throw i.status===401?new h(n,a):i.status===404?new f(n,a):i.status===403?new y(n,a):new E(n,i.status,void 0,a)}return i.json()})();return r.useCache&&_.set(n,o),o}))}async function ye(t){try{let r=await G.readFile(t,"utf-8"),e=JSON.parse(r);try{return C.parse(e)}catch(s){throw new p(t,s)}}catch(r){throw r instanceof p?r:new x(t,r)}}export{I as a,W as b,l as c,R as d,p as e,N as f,A as g,q as h,re as i,$ as j,ne as k,oe as l,fe as m,he as n,ye as o};
