{"version":3,"sources":["../src/commands/login/impl.ts","../src/lib/supabase.ts","../src/utils/auth.ts"],"sourcesContent":["import { serve } from '@hono/node-server'\r\nimport { Hono } from 'hono'\r\nimport { cors } from 'hono/cors'\r\nimport open from 'open'\r\nimport ora from 'ora'\r\n\r\nimport { AUTH_ORIGIN } from '#constants'\r\nimport type { LocalContext } from '#context'\r\nimport { createSupabaseClient } from '#lib/supabase'\r\nimport { writeConfig } from '#utils/auth'\r\n\r\ninterface LoginResponse {\r\n  token?: string\r\n}\r\n\r\nexport async function login(this: LocalContext) {\r\n  const responsePromise = new Promise<LoginResponse>((resolve, reject) => {\r\n    const app = new Hono()\r\n\r\n    let token: string | undefined\r\n\r\n    app.use(\r\n      cors({\r\n        origin: AUTH_ORIGIN,\r\n        allowMethods: ['GET'],\r\n        allowHeaders: ['Authorization'],\r\n      }),\r\n    )\r\n\r\n    app.use('/callback', async (c, next) => {\r\n      await next()\r\n      resolve({ token })\r\n    })\r\n\r\n    app.get('/callback', async (c) => {\r\n      const authHeader = c.req.header('Authorization')\r\n\r\n      if (!authHeader) {\r\n        return c.json(\r\n          { success: false, error: 'No authorization header provided' },\r\n          400,\r\n        )\r\n      }\r\n\r\n      token = authHeader.split(' ')[1]\r\n\r\n      if (!token) {\r\n        return c.json({ success: false, error: 'No token provided' }, 400)\r\n      }\r\n\r\n      return c.json({ success: true }, 200)\r\n    })\r\n\r\n    app.get('/success', async (c) =>\r\n      c.text('Login successful, you can close this tab.'),\r\n    )\r\n\r\n    app.get('/cancel', async (c) => {\r\n      reject(new Error('Login cancelled'))\r\n      return c.text('Login cancelled, you can close this tab.')\r\n    })\r\n\r\n    app.get('/error', async (c) => {\r\n      reject(new Error('Login error'))\r\n      return c.text('Login failed, you can close this tab.')\r\n    })\r\n\r\n    const server = serve({\r\n      fetch: app.fetch,\r\n      hostname: 'localhost',\r\n    })\r\n\r\n    server.listen()\r\n\r\n    const address = server.address()\r\n\r\n    let port: number | undefined\r\n    if (!address) {\r\n      reject(new Error('Failed to start server'))\r\n      return\r\n    }\r\n\r\n    if (typeof address === 'string') {\r\n      port = parseInt(address.split(':')[2] ?? '')\r\n    } else {\r\n      port = address.port\r\n    }\r\n\r\n    open(`${AUTH_ORIGIN}/login?callbackPort=${port}`)\r\n\r\n    console.log(\r\n      `If nothing happens, open the following URL in your browser: ${AUTH_ORIGIN}/login?callbackPort=${port}`,\r\n    )\r\n  })\r\n\r\n  const spinner = ora({\r\n    text: 'Authenticating...',\r\n    color: 'green',\r\n  })\r\n\r\n  try {\r\n    spinner.start()\r\n\r\n    const response = await responsePromise\r\n\r\n    spinner.stop()\r\n\r\n    if (!response.token) {\r\n      console.error('Failed to authenticate, please try again.')\r\n      return\r\n    }\r\n\r\n    const supabase = createSupabaseClient(response.token)\r\n\r\n    const { data, error } = await supabase.auth.getUser()\r\n\r\n    if (error) {\r\n      console.error('Failed to authenticate, please try again.')\r\n      return\r\n    }\r\n\r\n    console.log(`Hi ${data.user.email}, you are now logged in.`)\r\n\r\n    writeConfig({ token: response.token })\r\n  } catch (error) {\r\n    spinner.stop()\r\n    console.error(error)\r\n  }\r\n}\r\n","import { createClient } from '@supabase/supabase-js'\r\n\r\nexport function createSupabaseClient(token: string) {\r\n  return createClient(\r\n    /* @ts-ignore */\r\n    process.env.SUPABASE_URL!,\r\n    /* @ts-ignore */\r\n    process.env.SUPABASE_ANON_KEY!,\r\n    {\r\n      global: {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      },\r\n    },\r\n  )\r\n}\r\n","import { readFileSync, writeFileSync } from 'node:fs'\r\nimport os from 'node:os'\r\nimport path from 'node:path'\r\n\r\nconst CONFIG_FILE = '.saas-ui'\r\n\r\nexport type AuthData = {\r\n  token: string\r\n}\r\n\r\nexport async function writeConfig(data: AuthData) {\r\n  try {\r\n    const homeDir = os.homedir()\r\n    const filePath = path.join(homeDir, CONFIG_FILE)\r\n    writeFileSync(filePath, JSON.stringify(data))\r\n  } catch (error) {\r\n    console.error('Error writing to local config file', error)\r\n  }\r\n}\r\n\r\nexport async function readConfig(): Promise<AuthData | null> {\r\n  try {\r\n    const homeDir = os.homedir()\r\n    const filePath = path.join(homeDir, CONFIG_FILE)\r\n    const data = readFileSync(filePath, 'utf8')\r\n    return JSON.parse(data)\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n"],"mappings":"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","names":["serve","Hono","cors","open","ora","createClient","createSupabaseClient","token","readFileSync","writeFileSync","os","path","CONFIG_FILE","writeConfig","data","homeDir","filePath","error","login","responsePromise","resolve","reject","app","Hono","token","cors","AUTH_ORIGIN","c","next","authHeader","server","serve","address","port","open","spinner","ora","response","supabase","createSupabaseClient","data","error","writeConfig"]}